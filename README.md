# AstrBot 错误/空值重试插件 (Intelligent Retry)

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

一个为 [Astrbot](https://github.com/AstrBotDevs/AstrBot) 设计的增强型插件，专门解决与大语言模型（LLM）交互时常见的不稳定问题（如空回复、对话截断（常见于gemini2.5pro）等）。当 LLM 响应为空或出错时，会自动检测并智能重试，减少“无响应”或错误提示，让你的对话体验更顺畅、更省心。

当前版本：2.6.4

## ✨ 功能特性
  
- **可选启用 Gemini/LLM 截断重试**：检测回复结尾异常时自动重试，适配 Gemini 等模型常见“戛然而止”问题。
- **支持自定义截断判定正则**：可自定义回复结尾合法性判定规则，适配多种 LLM 输出风格。
- **重试间隔支持固定/指数退避模式**：可配置每次重试间隔为固定或指数递增，灵活适配不同场景。
- **自动重试**：在最终装饰阶段介入，直接替换结果，不打断事件流程。
- **智能检测**：
  1. 最终回复为空时自动重试；
  2. 文本包含错误关键词（如“请求失败”“api 返回的内容为空”等）时自动重试。
- **保持人设与上下文**：
  - 始终带上完整的会话上下文（包含当前轮）。
  - 支持“强制使用 Provider 人设”（always_use_system_prompt），会移除历史 system，并优先使用 Provider 的 system_prompt；若 Provider 无人设可配置 fallback_system_prompt。
  - 默认自动补位：当上下文无 system 时自动注入 Provider 的 system_prompt。
- **工具调用兼容**：检测到 finish_reason=tool_calls 时不干预，避免打断工具链。
- **重试退避**：支持指数退避（初始 retry_delay，随后×2，封顶 30s）。
- **失败兜底**：所有重试失败后返回可配置的兜底提示，避免“无响应”。

## 📦 安装

请在 AstrBot 的插件市场中搜索 `intelligent_retry` 进行安装，或通过以下方式手动安装：

1. 进入 AstrBot 主目录。
2. 打开 `data/plugins` 文件夹。
3. 执行 `git clone https://github.com/muyouzhi6/astrabot_plugin_retry.git`。
4. 重启 AstrBot 或在 WebUI 中重载插件。

## ⚙️ 配置

**所有配置项均可在 WebUI（网页界面）中插件管理页面进行设置，无需手动改代码，小白也能轻松上手！**

安装并重载插件后，你可以在 AstrBot 的 WebUI -> 插件管理 -> Intelligent Retry -> 管理 -> 配置 中对插件进行设置。

| 配置项 | 类型 | 描述 | 默认值 |
| :--- | :--- | :--- | :--- |
| **最大重试次数** | `整数` | 当 LLM 回复无效时，插件尝试重新请求的最大次数。设置为 0 则禁用重试。 | `3` |
| **重试间隔（秒）** | `整数` | 每次重试之间的等待时间，单位为秒。 | `2` |
| **重试间隔模式** | `字符串` | 选择重试间隔的模式。`fixed`=每次重试间隔固定，`exponential`=指数退避（每次翻倍，最大30秒）。 | `exponential` |
| **启用截断重试** | `布尔` | 检测到回复结尾不是常见标点/字母/数字/文件后缀/网址时自动重试（如 Gemini 截断），建议仅在遇到相关问题时开启。 | `false` |
| **截断判定合法结尾正则** | `字符串` | 用于判定回复结尾是否完整，支持自定义正则，默认已覆盖常见标点、字母、数字、文件后缀、网址等。 | `[。！？!?,.\w\d\u4e00-\u9fa5]$|\.(com|cn|org|net|io|ai|pdf|jpg|png|jpeg|gif|mp3|mp4|txt|zip|tar|gz|html|htm)$|https?://[\w\.-]+$` |
| **触发重试的错误关键词** | `文本` | 当 LLM 的回复中包含这些关键词时，将触发重试。每行一个，不区分大小写。 | (见默认值) |
| **强制使用 Provider 人设** | `布尔` | 开启后移除上下文里所有 system 消息，并统一使用 Provider 的 system_prompt（防“人设污染”）。 | `true` |
| **备用人设(system prompt)** | `文本` | 当 Provider 无人设且启用强制人设时，使用此文本作为人设。 | 空 |
| **允许重试的 HTTP 状态码** | `文本` | 错误文本中出现这些码时允许重试，每行一个。 | 400, 429, 502, 503, 504 |
| **禁止重试的 HTTP 状态码** | `文本` | 错误文本中出现这些码时直接跳过重试。 | 空 |
| **调试：输出上下文预览** | `布尔` | 在重试时输出最近 N 条上下文的简要预览（DEBUG 日志）。 | false |
| **预览条目数** | `整数` | 启用预览时，显示最近 N 条历史。 | 3 |
| **预览最大字符数** | `整数` | 启用预览时，每条预览裁剪后的最大字符数。 | 120 |
| **兜底回复** | `文本` | 达到最大重试次数仍失败时，发送给用户的友好提示。留空则不发送消息。 | 抱歉，刚才遇到服务波动... |
  
- **可选启用 Gemini/LLM 截断重试**：检测回复结尾异常时自动重试，适配 Gemini 等模型常见“戛然而止”问题。
- **重试间隔支持固定/指数退避模式**：可配置每次重试间隔为固定或指数递增，灵活适配不同场景。
配置修改后会自动保存并生效。

## 📝 使用方法

本插件无需命令，安装并启用后自动工作。它会在结果装饰阶段介入，对用户透明。

验证人设/上下文是否被带上：观察调试日志中如下行：

- “上下文长度: N, 系统提示词存在: True/False, 上下文含system: True/False，示例: …”
- 若“上下文含system: True”，说明历史对话里有人设消息；否则若系统提示词存在，则会补位 system_prompt。

若启用“调试：输出上下文预览”，还会看到类似：

```
上下文预览(最近 3 条):
#1 [user] ……
#2 [assistant] ……
#3 [user] ……
```

当开启“强制使用 Provider 人设”时，日志会提示“已强制覆盖人设：移除 X 条历史 system 消息”，并无条件传入 Provider 的 system_prompt。

提示：若希望始终携带固定人设，建议在 Provider 中配置 system_prompt；若人设写在会话开头（system 角色），插件会自动沿用。

## ❓ 常见问题/注意事项

- 插件只会在检测到回复异常时才触发重试，不会影响正常对话。
- 某些极端情况下，LLM 服务端问题可能无法完全避免，遇到多次失败时会显示兜底提示。
- 所有配置均可通过 WebUI 修改，无需手动编辑 config 文件或改代码。
- 建议开启调试日志以便排查问题（如需详细上下文信息）。
- 如果插件无效，建议先检查 AstrBot 版本和插件是否正确启用。

## 🤝 贡献

欢迎通过提交 Pull Request 或 Issue 来为本项目做出贡献，您的 Star🌟 是对我最大的鼓励！！

## 📄 开源许可证

本项目基于 [MIT License](LICENSE) 开源。

## ✍️ 作者

- [@muyouzhi6](https://github.com/muyouzhi6)
- [@长安某](https://github.com/ChanganZhou)
